<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singularity 3D Cinematic - Standalone Engine</title>
    <!-- Google Fonts for sleek tech look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Fira+Code&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-primary-glass: rgba(10, 14, 26, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-blur: blur(16px);
            --text-primary: #f3f4f6;
            --accent-secondary: #ff9900;
        }

        body {
            margin: 0;
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            overflow: hidden;
            /* Standalone: Fullscreen experience */
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* Essential Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #050505;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 1s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.5);
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        #progress-text {
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
        }

        #stats-text {
            color: grey;
            font-size: 0.8rem;
            margin-top: 10px;
            font-family: 'Fira Code', monospace;
        }

        /* Custom GUI overrides */
        .lil-gui {
            --background-color: rgba(10, 10, 10, 0.85);
            --text-color: #eee;
            --focus-color: var(--accent-secondary);
            z-index: 100;
        }

        /* FPS Monitor Styles */
        #fps-monitor {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            background: var(--bg-primary-glass);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--accent-secondary);
        }
    </style>
    <!-- Import maps polyfill -->
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
          "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
        }
      }
    </script>
</head>

<body>
    <!-- Full Boilerplate for the high-fidelity 3D Engine -->
    <div id="loader">
        <div class="spinner"></div>
        <div id="progress-text">CALIBRATING SINGULARITY: 0%</div>
        <div id="stats-text">Parsing 534k Triangles...</div>
    </div>

    <div id="fps-monitor">FPS: --</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import GUI from 'lil-gui';

        // --- LITERAL CONFIGURATION FROM BLACK_HOLE.HTML ---
        const config = {
            // Environment
            bgColor: '#000000',
            exposure: 0.1,

            // Post-Processing (Bloom)
            bloomStrength: 0.5,
            bloomRadius: 0.1,
            bloomThreshold: 0,

            // Lighting
            dirLightIntensity: 0.1,
            dirLightColor: '#ffffff',
            dirLightX: 5,
            dirLightY: 5,
            dirLightZ: 5,
            ambLightIntensity: 0.1,
            ambLightColor: '#ffffff',
            diskLightIntensity: 2.0,

            // Materials
            matColor: '#000000',
            ringIntensity: 4.0,
            coreIntensity: 3.5,
            roughness: 0.0,
            metalness: 0.0,

            // Orbit Controls
            autoRotate: true,
            autoRotateSpeed: 0.1,
            dampingFactor: 0.05,
            camX: -1493.6135802384338,
            camY: -586.3739130675725,
            camZ: -510.60303547547716
        };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(config.bgColor);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 20000);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: "high-performance" });
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = config.exposure;
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = config.dampingFactor;
        controls.autoRotate = config.autoRotate;
        controls.autoRotateSpeed = config.autoRotateSpeed;
        controls.enableZoom = true; // RE-ENABLED FOR STANDALONE

        const light = new THREE.DirectionalLight(config.dirLightColor, config.dirLightIntensity);
        light.position.set(config.dirLightX, config.dirLightY, config.dirLightZ);
        scene.add(light);

        const ambientLight = new THREE.AmbientLight(config.ambLightColor, config.ambLightIntensity);
        scene.add(ambientLight);

        const diskLight = new THREE.PointLight(0xffffff, config.diskLightIntensity, 0, 1.5);
        diskLight.position.set(0, 0, 0);
        scene.add(diskLight);

        camera.position.set(config.camX, config.camY, config.camZ);
        controls.update();

        // --- Post-Processing Pipeline ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight),
            config.bloomStrength,
            config.bloomRadius,
            config.bloomThreshold
        );
        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- THE FULL GUI SETUP FROM THE ORIGINAL PROJECT ---
        const gui = new GUI({ title: 'Singularity Parameters' });
        gui.close();

        const fCredits = gui.addFolder('Credits (3D Assets)');
        const creditInfo = {
            'Model': 'Black Hole',
            'Author': 'NestaEric',
            'License': 'CC-BY-4.0',
            'Open Source': () => window.open('https://sketchfab.com/3d-models/black-hole-e410da98b1e5445eae2acafaaa53587d', '_blank')
        };
        fCredits.add(creditInfo, 'Model').disable();
        fCredits.add(creditInfo, 'Author').disable();
        fCredits.add(creditInfo, 'License').disable();
        fCredits.add(creditInfo, 'Open Source').name('View Original Model');

        const fEnv = gui.addFolder('Environment');
        fEnv.addColor(config, 'bgColor').name('Background').onChange(v => scene.background.set(v));
        fEnv.add(config, 'exposure', 0, 5, 0.1).name('Exposure').onChange(v => renderer.toneMappingExposure = v);

        const fBloom = gui.addFolder('Post-Processing (Bloom)');
        fBloom.add(config, 'bloomStrength', 0, 10, 0.1).name('Strength').onChange(v => bloomPass.strength = v);
        fBloom.add(config, 'bloomRadius', 0, 5, 0.1).name('Radius').onChange(v => bloomPass.radius = v);
        fBloom.add(config, 'bloomThreshold', 0, 2, 0.05).name('Threshold').onChange(v => bloomPass.threshold = v);

        const fLight = gui.addFolder('Lighting');
        fLight.add(config, 'dirLightIntensity', 0, 10, 0.1).name('Dir Intensity').onChange(v => light.intensity = v);
        fLight.addColor(config, 'dirLightColor').name('Dir Color').onChange(v => light.color.set(v));
        fLight.add(config, 'ambLightIntensity', 0, 5, 0.1).name('Amb Intensity').onChange(v => ambientLight.intensity = v);
        fLight.addColor(config, 'ambLightColor').name('Amb Color').onChange(v => ambientLight.color.set(v));
        fLight.add(config, 'diskLightIntensity', 0, 50, 1).name('Disk Light').onChange(v => diskLight.intensity = v);

        const fMat = gui.addFolder('Material Engineering');
        fMat.addColor(config, 'matColor').name('Base Color').onChange(v => {
            modelMeshes.forEach(m => { if (m.material.color) m.material.color.set(v); });
        });
        fMat.add(config, 'ringIntensity', 0, 100, 1.0).name('Accretion Disk').onChange(v => {
            modelMeshes.forEach(m => { if (m.material.name.includes('ring')) m.material.emissiveIntensity = v; });
        });
        fMat.add(config, 'coreIntensity', 0, 50, 0.5).name('Event Horizon').onChange(v => {
            modelMeshes.forEach(m => { if (m.material.name.includes('light') || m.material.name.includes('blackoutside')) m.material.emissiveIntensity = v; });
        });
        fMat.add(config, 'roughness', 0, 1, 0.05).name('Roughness').onChange(v => { modelMeshes.forEach(m => m.material.roughness = v); });
        fMat.add(config, 'metalness', 0, 1, 0.05).name('Metalness').onChange(v => { modelMeshes.forEach(m => m.material.metalness = v); });

        const fCtrl = gui.addFolder('Orbit & Camera');
        fCtrl.add(config, 'autoRotate').name('Auto-Rotate').onChange(v => controls.autoRotate = v);
        fCtrl.add(config, 'autoRotateSpeed', -10, 10, 0.1).name('Rotate Speed').onChange(v => controls.autoRotateSpeed = v);
        fCtrl.add(config, 'camX', -5000, 5000, 0.1).name('Cam X').listen().onChange(v => { camera.position.x = v; controls.update(); });
        fCtrl.add(config, 'camY', -5000, 5000, 0.1).name('Cam Y').listen().onChange(v => { camera.position.y = v; controls.update(); });
        fCtrl.add(config, 'camZ', -5000, 5000, 0.1).name('Cam Z').listen().onChange(v => { camera.position.z = v; controls.update(); });

        // --- ASSETS LOADING ---
        const texLoader = new THREE.TextureLoader();
        const envTexture = texLoader.load('assets/env_stars.png');
        envTexture.mapping = THREE.EquirectangularReflectionMapping;
        envTexture.colorSpace = THREE.SRGBColorSpace;
        scene.environment = envTexture;

        let modelMeshes = [];
        const loader = new GLTFLoader();

        loader.load('black_hole-v2/black_hole.gltf', function (gltf) {
            const model = gltf.scene;
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    modelMeshes.push(child);
                    const mat = child.material;
                    const matName = mat.name || "";

                    if (matName.includes('ring')) {
                        if (mat.map && !mat.emissiveMap) mat.emissiveMap = mat.map;
                        mat.transparent = true;
                        mat.side = THREE.DoubleSide;
                        mat.emissive.set(0xffffff);
                        mat.emissiveIntensity = config.ringIntensity;
                        mat.transmission = matName === 'ring2' ? 0.95 : 0.6;
                        mat.thickness = 2.0;
                        mat.ior = 1.5;
                        mat.clearcoat = 1.0;
                        mat.clearcoatRoughness = 0.05;
                    } else if (matName.includes('center') || matName.includes('blackoutside')) {
                        // THE ABSOLUTE BLACK FIX
                        mat.color.set(0x000000);
                        mat.emissive.set(0x000000);
                        mat.envMapIntensity = 0.0;
                        mat.transparent = false;
                        mat.opacity = 1.0;
                        mat.depthWrite = true;
                        mat.depthTest = true;
                        mat.roughness = 1.0;
                        mat.metalness = 0.0;
                    } else if (matName.includes('light')) {
                        mat.emissiveIntensity = config.coreIntensity;
                    } else if (matName.includes('distortion')) {
                        mat.transparent = true;
                        mat.opacity = 0.0;
                        mat.visible = false;
                    }

                    const maxAnisotropy = renderer.capabilities.getMaxAnisotropy();
                    const applyTexSettings = (tex) => {
                        if (tex) { tex.anisotropy = maxAnisotropy; tex.wrapS = tex.wrapT = THREE.RepeatWrapping; }
                    };
                    applyTexSettings(mat.map);
                    applyTexSettings(mat.emissiveMap);
                    applyTexSettings(mat.normalMap);
                    applyTexSettings(mat.roughnessMap);
                    applyTexSettings(mat.metalnessMap);
                }
            });
            scene.add(model);
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
        }, function (xhr) {
            const percent = (xhr.loaded / xhr.total) * 100;
            document.getElementById('progress-text').innerText = `SYNCING SINGULARITY: ${percent.toFixed(0)}%`;
        });

        // --- ENGINE LOOP ---
        let lastTime = 0, frameCount = 0;
        const fpsMonitor = document.getElementById('fps-monitor');

        function animate(time) {
            requestAnimationFrame(animate);
            frameCount++;
            if (time > lastTime + 1000) {
                fpsMonitor.innerText = `FPS: ${Math.round(frameCount * 1000 / (time - lastTime))}`;
                frameCount = 0; lastTime = time;
            }
            controls.update();
            config.camX = camera.position.x;
            config.camY = camera.position.y;
            config.camZ = camera.position.z;
            composer.render();
        }
        requestAnimationFrame(animate);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>